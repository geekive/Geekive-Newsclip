<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>뉴스 타임라인 - 점선 연결</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/jquery/jquery-3.7.1.min.js') }}"></script>
</head>
<body>
    {% include 'modal/news_view.html' %}

    <!-- header / search :: s -->
    <div class="header p-cb">
        <div class="logo">
            Newsclip
        </div>
        <div class="sign-wrapper p-cc">
            <div class="signin">
                로그인
            </div>
            <div class="signup">
                회원가입
            </div>
            <div class="spliter"></div>
            <div class="search-toggle">
                조건검색 열기
            </div>
        </div>
    </div>
    <div class="search-wrapper p-cc">
        {% for news_item in news %}
            {{ news_item.TITLE }}
        {% endfor %}
    </div>
    <script>
        $(function(){
            const $toggleBtn = $(".search-toggle");
            const $searchWrapper = $(".search-wrapper");
            const $timeline = $(".timeline-container");

            $toggleBtn.on("click", function () {
                const isActive = $searchWrapper.toggleClass("active").hasClass("active");
                $timeline.toggleClass("pushed");
                $toggleBtn.text(isActive ? "조건검색 닫기" : "조건검색 열기");
            });
        })
    </script>
    <!-- header / search :: e -->

    <div class="timeline-container">
        <!-- timeline header :: s -->
        <div class="timeline-header">
            <div class="topic p-cc">
                 토픽
                <div class="topic-menu-wrapper">
                    <svg id="btn-topic-menu" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                        fill="currentColor" viewBox="0 0 16 16">
                        <path
                            d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
                    </svg>
                    <div id="topic-menu">
                        <div id="btn-topic-new" class="p-cc" data-disabled="false">신규</div>
                        <div class="p-cc">추가</div>
                        <div class="p-cc">수정</div>
                        <div class="p-cc">숨기기</div>
                        <div id="btn-topic-delete" class="p-cc" data-open="false">삭제</div>
                    </div>
                </div>
            </div>
            <div class="timeline p-cc">타임라인</div>
        </div>
        <!-- timeline header :: e -->

        <!-- timeline body :: s -->
        <div id="timeline-body"></div>
        <!-- timeline body :: e -->
    </div>
    <script>
        class Timeline{
            constructor(){
                this.obj = {
                    document                : {$ : $(document)}
                    , timelineBody          : {$ : $('#timeline-body')}
                    , timelineRowContainer  : {selector : '.timeline-row-container'}
                    , timelineRow           : {selector : '.timeline-row'}
                    , topicMenu             : {$ : $('#topic-menu')}
                    , topicNameArea         : {selector : '.topic-name-area'}
                    , txt : {
                        topicName   : {selector : '.txt-topic-name'}
                    }
                    , btn : {
                        topicMenu           : {$ : $('#btn-topic-menu')}
                        , topicNew          : {$ : $('#btn-topic-new')}
                        , topicNewSave      : {selector : '#btn-topic-new-save'}
                        , topicNewCancel    : {selector : '#btn-topic-new-cancel'}
                        , topicDelete       : {$ : $('#btn-topic-delete')}
                        , topicDeleteSave   : {selector : '.btn-topic-delete-save'}
                    }
                    , modal : {
                        newsUpsert : {
                            $               : $('#news-modal-overlay')
                            , urlContainer  : {$ : $('#upsert-modal-url-container')}
                            , newsList      : {$ : $('#news-modal-news-list')}
                            , txt : {
                                topicName   : {$ : $('#txt-news-modal-topic-name')}
                                , title     : {$ : $('#txt-news-modal-title')}
                                , date      : {$ : $('#txt-news-modal-date')}
                                , memo      : {$ : $('#txt-news-modal-memo')}
                                , url       : {$ : $('#txt-news-modal-url')}
                            }
                            , hid : {
                                topicUid : {$ : $('#hid-news-modal-topic-uid')}
                            }
                            , rdo : {
                                importance : {$ : $('input[name="rdo-news-modal-importance"]')}
                            }
                            , btn : {
                                save        : {$ : $('#btn-news-modal-save')}
                                , close     : {$ : $('#btn-news-modal-edit')}
                                , addUrl    : {$ : $('#btn-news-modal-add-url')}
                            }
                        }
                    }
                }
                this.eventHandlers = {
                    selectTimelineList          : this.fnSelectTimelineList
                    , openTopicMenu             : this.fnOpenTopicMenu
                    , getTimelineTemplate       : this.fnGetTimelineTemplate
                    , showTopicDeleteSaveButton : this.fnShowTopicDeleteSaveButton
                    , deleteTopic               : this.fnDeleteTopic
                    , openNewsUpsertModal       : this.fnOpenNewsUpsertModal
                    , closeNewsUpsertModal      : this.fnCloseNewsUpsertModal
                    , addUrl                    : this.fnAddUrl
                    , resetNewsUpsertModal      : this.fnResetNewsUpsertModal
                    , saveNews                  : this.fnSaveNews
                }
                this.init();
            }

            init(){
                this.eventHandlers.selectTimelineList();
                this.addEventListeners();
            }

            addEventListeners(){
                this.obj.document.$.on('click', () => {
                    this.obj.topicMenu.$.hide();
                })
                this.obj.btn.topicMenu.$.on('click', this.eventHandlers.openTopicMenu.bind(this));
                this.obj.btn.topicNew.$.on('click', this.eventHandlers.getTimelineTemplate.bind(this));
                this.obj.btn.topicDelete.$.on('click', this.eventHandlers.showTopicDeleteSaveButton.bind(this));
                this.obj.document.$.on('click', this.obj.btn.topicDeleteSave.selector, this.eventHandlers.deleteTopic);
                this.obj.document.$.on('click', this.obj.timelineRow.selector, this.eventHandlers.openNewsUpsertModal);
                this.obj.modal.newsUpsert.btn.close.$.on('click', this.eventHandlers.closeNewsUpsertModal.bind(this));
                this.obj.modal.newsUpsert.btn.save.$.on('click', this.eventHandlers.saveNews.bind(this));
                this.obj.modal.newsUpsert.btn.addUrl.$.on('click', this.eventHandlers.addUrl.bind(this))
            }

            fnSelectTimelineList = () => {
                $.post("/timeline/list", (html) => {
                    this.obj.timelineBody.$.empty();
                    this.obj.timelineBody.$.prepend(html);
                });
            }

            /* topic :: s */
            fnOpenTopicMenu = (e) => {
                e.stopPropagation();
                this.obj.topicMenu.$.toggle();
            }

            fnGetTimelineTemplate = () => {
                let isDisabled      = this.obj.btn.topicNew.$.data('disabled');
                let isDeleteOpen    = this.obj.btn.topicDelete.$.data('open');
                if(isDisabled){
                    alert('이미 토픽 생성 행이 존재합니다.');
                }else if(isDeleteOpen){
                    alert('토픽 삭제 중에 생성 기능이 제한됩니다.');
                }else{
                    $.post("/timeline/template", (template) => {
                        let $template           = $(template);
                        let $btnTopicNewSave    = $template.find(this.obj.btn.topicNewSave.selector);
                        let $btnTopicNewCancel  = $template.find(this.obj.btn.topicNewCancel.selector);
                        let $btnTopicDeleteSave = $template.find(this.obj.btn.topicDeleteSave.selector);
                        let $txtTopicName       = $template.find(this.obj.txt.topicName.selector);
                        let $topicNameArea      = $template.find(this.obj.topicNameArea.selector);
                        let $timelineRow        = $template.find(this.obj.timelineRow.selector);
                        
                        $btnTopicNewSave.on('click', () => {
                            let topicName = $txtTopicName.val();
                            if(!topicName.trim()){
                                alert('토픽 이름을 입력하세요.');
                                return
                            }

                            $.ajax({
                                url             : '/topic/save'
                                , method        : 'POST'
                                , contentType   : 'application/json'
                                , data          : JSON.stringify({topic_name : topicName})
                                , success       : (response) => {
                                    if(response.resultCode == 'success'){
                                        let topicUid = response.data.topic_uid;
                                        
                                        $topicNameArea.html(topicName);
                                        $btnTopicDeleteSave.data('topic-uid', topicUid);
                                        $timelineRow.data('topic-uid', topicUid);
                                        $timelineRow.data('topic-name', topicName);
                                        
                                        $btnTopicNewSave.remove();
                                        $btnTopicNewCancel.remove();
                                        $txtTopicName.hide();

                                        this.obj.btn.topicNew.$.data('disabled', false);
                                    }
                                }
                            })
                        })

                        $btnTopicNewCancel.one('click', () => {
                            $btnTopicNewCancel.closest(this.obj.timelineRowContainer.selector).remove();
                            this.obj.btn.topicNew.$.data('disabled', false);
                        })
                        this.obj.btn.topicNew.$.data('disabled', true);
                        this.obj.timelineBody.$.prepend($template);
                    });
                }
            }

            fnShowTopicDeleteSaveButton = () => {
                let isDisabled = this.obj.btn.topicNew.$.data('disabled');
                if(isDisabled){
                    alert('토픽 생성 행이 존재하여 삭제 기능이 제한됩니다.');
                    return
                }

                let isDeleteOpen = this.obj.btn.topicDelete.$.data('open');
                this.obj.btn.topicDelete.$.data('open', !isDeleteOpen);

                $(this.obj.btn.topicDeleteSave.selector).toggle();
                this.obj.btn.topicDelete.$.html(isDeleteOpen ? '삭제' : '삭제 종료');
            }

            fnDeleteTopic = (e) => {
                let $this = $(e.target);
                if(confirm('토픽과 연결된 뉴스도 전부 삭제됩니디.\n토픽을 삭제 하시겠습니까?')){
                    $.ajax({
                        url             : '/topic/delete'
                        , method        : 'POST'
                        , contentType   : 'application/json'
                        , data          : JSON.stringify({topic_uid : $this.data('topic-uid')})
                        , success       : (response) => {
                            if(response.resultCode == 'success'){
                                alert(response.resultMessage);
                                $this.closest(this.obj.timelineRowContainer.selector).remove();
                            }
                        }
                    })
                }
            }
            /* topic :: e */

            /* timeline :: s */
            fnOpenNewsUpsertModal = (e) => {
                let $this       = $(e.currentTarget);
                let topicUid    = $this.data('topic-uid');
                let topicName   = $this.data('topic-name');
                
                if(!topicUid.trim()){
                    return
                }

                this.obj.modal.newsUpsert.$.css('display', 'flex');
                this.obj.modal.newsUpsert.hid.topicUid.$.val(topicUid);
                this.obj.modal.newsUpsert.txt.topicName.$.val(topicName);
            }

            fnCloseNewsUpsertModal = () => {
                this.obj.modal.newsUpsert.$.css('display', 'none');
                this.eventHandlers.resetNewsUpsertModal();
            }

            fnAddUrl = () => {
                let url = this.obj.modal.newsUpsert.txt.url.$.val();
                $.ajax({
                    url             : '/news/web-scraping'
                    , method        : 'POST'
                    , contentType   : 'application/json'
                    , data          : JSON.stringify({url : url})
                    , success       : (response) => {
                        if(response.code == 'success'){
                            let data = response.data;
                            this.obj.modal.newsUpsert.newsList.$.prepend(data);
                            //this.eventHandlers.selectTimelineList();
                            //this.eventHandlers.closeNewsUpsertModal();
                        }
                    }
                })

            }

            fnResetNewsUpsertModal = () => {
                this.obj.modal.newsUpsert.hid.topicUid.$.val('');
                this.obj.modal.newsUpsert.txt.topicName.$.val('');
                this.obj.modal.newsUpsert.txt.title.$.val('');
                this.obj.modal.newsUpsert.txt.date.$.val('');
                this.obj.modal.newsUpsert.txt.memo.$.val('');
                this.obj.modal.newsUpsert.rdo.importance.$.first().trigger('click');
                
                let $url = this.obj.modal.newsUpsert.$.find(this.obj.modal.newsUpsert.txt.url.selector);
                $url.each(function(i){
                    if(i > 2){
                        $(this).remove();
                    }else{
                        $(this).val('');
                    }
                })
            }

            fnSaveNews = () => {
                let topicUid    = this.obj.modal.newsUpsert.hid.topicUid.$.val();
                let title       = this.obj.modal.newsUpsert.txt.title.$.val();
                let date        = this.obj.modal.newsUpsert.txt.date.$.val();
                let memo        = this.obj.modal.newsUpsert.txt.memo.$.val();
                let importance  = this.obj.modal.newsUpsert.rdo.importance.$.filter(':checked').val();
                let $url        = this.obj.modal.newsUpsert.$.find(this.obj.modal.newsUpsert.txt.url.selector);
                let urlArray    = new Array();

                if(!title.trim()){
                    alert('제목을 입력하세요.'); return
                }
                if(!date.trim()){
                    alert('날짜를 선택하세요.'); return
                }

                $url.each(function(){
                    urlArray.push($(this).val().trim());
                })

                let params = {
                    topic_uid       : topicUid
                    , title         : title
                    , date          : date
                    , memo          : memo
                    , importance    : importance
                    , url_array     : urlArray
                }

                $.ajax({
                    url             : '/news/save'
                    , method        : 'POST'
                    , contentType   : 'application/json'
                    , data          : JSON.stringify(params)
                    , success       : (response) => {
                        if(response.resultCode == 'success'){
                            this.eventHandlers.selectTimelineList();
                            this.eventHandlers.closeNewsUpsertModal();
                        }
                    }
                })
            }
            /* timeline :: e */
            
        }
        const timeline = new Timeline();
    </script>

    <div class="footer">
        © 2025 Geekive (Geekive Newsclip). All rights reserved.<br>
        Copyrights of the clipped articles and content belong to their respective newspapers.
    </div>
</body>

</html>